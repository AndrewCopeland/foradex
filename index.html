<!DOCTYPE html>
<html>
<head>
  <title>Foradex</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    const defaultResourceTypes = [
      "mushroom",
      "berry",
      "flower",
      "tree",
      "herb",
      "other"
    ]

    const createOption = (value) => {
          let opt = document.createElement("option")
          opt.value = value
          opt.innerHTML = value
          return opt
    }

    const refreshForadexTable = () => {
      const actualForadex = getForadex()

      const createForadexCell = (value) => {
          let cell = document.createElement("th")
          cell.innerText = value
          return cell
      }

      const createForadexGoogleMapsCall = (long, lat) => {
        let cell = document.createElement("th")
        let link = document.createElement("a")
        link.href = `https://www.google.com/maps/search/?api=1&query=${lat},${long}`
        link.innerText = "Map"
        console.log("google query: " + link.href)
        cell.appendChild(link)
        return cell
      }

      const createForadexRow = (find) => {
        let row = document.createElement("tr")
        row.appendChild(createForadexCell(find.date))
        row.appendChild(createForadexCell(find.name))
        row.appendChild(createForadexCell(find.locationName))
        row.appendChild(createForadexCell(find.type))
        row.appendChild(createForadexCell(find.locationLat))
        row.appendChild(createForadexCell(find.locationLong))
        row.appendChild(createForadexGoogleMapsCall(find.locationLong, find.locationLat))
        return row
      }

      let tableForadex = document.getElementById("foradex-table-body")
      tableForadex.innerHTML = ""
      actualForadex.find.reverse().map((find, i ) => {
        tableForadex.appendChild(createForadexRow(find))
      })
    }

    const initForadex = () => {
        const foradex = localStorage.getItem("foradex")
        if (foradex === null) {
          setForadex({
            "resource": [],
            "location": [],
            "find": [],
            "resourceType": defaultResourceTypes
          })        
        }

        const actualForadex = getForadex()

        // populate the selects for resource and find type
        let selectResourceType = document.getElementById("resource-type")
        let selectFindType = document.getElementById("find-type")
        actualForadex.resourceType.map((resourceType, i) => {
          selectResourceType.appendChild(createOption(resourceType))
          selectFindType.appendChild(createOption(resourceType))
        })

        // refresh table
        refreshForadexTable()

        // populate the find date
        let dateFindDate = document.getElementById("find-date")
        const currentDate = getCurrentDate()
        console.log("current date: " + currentDate)
        dateFindDate.value = currentDate
    }

    const getCurrentDate = () => {
      const currentDate = new Date();
      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const day = String(currentDate.getDate()).padStart(2, '0');
      const formattedDate = `${year}-${month}-${day}`;
      return formattedDate;
    }
    
    const getForadex = () => {
        return JSON.parse(localStorage.getItem("foradex"))
    }

    const setForadex = (foradex) => {
        return localStorage.setItem("foradex", JSON.stringify(foradex))
    }

    const appendResource = (type, body) => {
        let foradex = getForadex()
        foradex[type].push(body)
        setForadex(foradex)
    }

    const saveFormData = () => {
      const name = document.getElementById("find-name").value;
      const type = document.getElementById("find-type").value;
      const date= document.getElementById("find-date").value;
      const locationName = document.getElementById("find-locationName").value;
      const locationLong = document.getElementById("find-locationLong").value;
      const locationLat = document.getElementById("find-locationLat").value;

      const formData = {
        name: name,
        type: type,
        date: date,
        locationName: locationName,
        locationLong: locationLong,
        locationLat: locationLat
      };

      appendResource("find", formData)

      alert("Find saved!");

      refreshForadexTable()
    }

    const saveResourceForm = () => {
      const type = document.getElementById("resource-type").value
      const name = document.getElementById("resource-name").value

      const data = {
        type: type,
        name: name
      }
      appendResource("resource", data) 

      alert("Resource saved!");
    }

    const getCurrentLocation = () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            // Do something with the latitude and longitude values
            console.log(position.coords)
            console.log("Latitude: " + latitude);
            console.log("Longitude: " + longitude);

            // set the elements
            let locationLongElement = document.getElementById("find-locationLong") 
            let locationLatElement = document.getElementById("find-locationLat")
            locationLongElement.value = longitude
            locationLatElement.value = latitude
          },
          function(error) {
            console.error("Error getting location:", error);
          }
        );
      } else {
        console.error("Geolocation is not supported by this browser.");
      }
    }

    const initWebsite = () => {
        initForadex()
        getCurrentLocation()
    }

    window.addEventListener("DOMContentLoaded", () => { // when the page has loaded the DOM elements
      let findTypeSelect = document.getElementById("find-type")
      let findNameSelect = document.getElementById("find-name")
      findTypeSelect.addEventListener("change", (e) => {
        // clear all children option elements in the findNameSelect
        findNameSelect.innerHTML = `<option value="" selected disabled>Select an option</option>`
        // modifying the find-name to only include the type selected
        const resourceType = findTypeSelect.value
        console.log("find type was selected: " + resourceType)
        const foradex = getForadex()
        foradex.resource.map((resource, i) => {
          if (resource.type === resourceType) {
            findNameSelect.appendChild(createOption(resource.name))
          }
        })
      })
    })

    window.onload = initWebsite
  </script>
</head>
<body>
  <h1>Foradex</h1>
  <h4>a tool that logs a forager's findings and location</h4>
  <hr/>
  <h2>Add New Resource</h2>
  <form>

    <label for="type">Type:</label>
    <select id="resource-type" name="type" required>
      <option value="" selected disabled>Select an option</option>
    </select>

    <label for="name">Name:</label>
    <input type="text" id="resource-name" name="name" required>

    <button type="button" onclick="saveResourceForm()">Submit</button>
  </form>
  <hr/>
  <h2>Add New Find</h2>
  <form>
    <label for="type">Type:</label>
    <select id="find-type" name="type" required>
      <option value="" selected disabled>Select an option</option>
    </select>

    <label for="name">Name:</label>
    <select id="find-name" name="name" required>
      <option value="" selected disabled>Select an option</option>
    </select>

    <label for="locationName">Location Name:</label>
    <input type="text" id="find-locationName" name="locationName" required>
    
    <label for="date">Date:</label>
    <input type="date" id="find-date" name="date" required>
    
    <label for="locationLong">Location Longitude:</label>
    <input type="text" id="find-locationLong" name="locationLong" required>
    
    <label for="locationLat">Location Latitude:</label>
    <input type="text" id="find-locationLat" name="locationLat" required>
    
    <button type="button" onclick="saveFormData()">Submit</button>
  </form>
  <hr/>
  <h2>My Foradex</h2>
  <table id="foradex-table" class="foradex-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Name</th>
        <th>Location</th>
        <th>Type</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Google Maps</th>
      </tr>
    </thead>
    <tbody id="foradex-table-body">
    </tbody>
  </table>
  <hr/>
  <h2>Motivation</h2>
  <p>I was frustrated with the bloated foraging apps that currently exist and wanted a simple light weight tool to log my foraging finds.</p>
  <p>Own <b>all your data</b></p>
  <p>No <b>login required</b></p>
  <p>No <b>internet required</b></p>
  <p>No <b>cloud storage</b></p>
  <p>Hopefully we can share our foradexes some day ðŸ˜œ</p>
  <hr/>
  <div class="footer">
    <p><a href="https://github.com/AndrewCopeland/foradex">Github</a></p>
  </div>
</body>
</html>

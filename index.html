<!DOCTYPE html>
<html>
<head>
  <title>Foradex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="canonical" href="https://andrewcopeland.github.io/foradex" />
  <link rel="stylesheet" href="/foradex/css/water.css">
  <script type="text/javascript">
    if (navigator.serviceWorker) {
      navigator.serviceWorker.register('/foradex/sw.js', {scope: '/foradex/'})
    }
    const defaultResourceTypes = [
      "Mushroom",
      "Berry",
      "Tree",
      "Herb",
      "Flower",
      "Other"
    ]

    const defaultResources = [
      // mushrooms
      {
        "type": "Mushroom",
        "name": "Chicken of the Woods"
      },
      {
        "type": "Mushroom",
        "name": "Black Trumpet"
      },
      {
        "type": "Mushroom",
        "name": "Hen of the Woods"
      },
      {
        "type": "Mushroom",
        "name": "Chanterelle"
      },
      {
        "type": "Mushroom",
        "name": "Morel"
      },

      // berries
      {
        "type": "Berry",
        "name": "Blueberry"
      },
      {
        "type": "Berry",
        "name": "Rasberry"
      },
      {
        "type": "Berry",
        "name": "Blackberry"
      },
      {
        "type": "Berry",
        "name": "Serviceberry"
      },

      // tree
      {
        "type": "Tree",
        "name": "PawPaw"
      },
      {
        "type": "Tree",
        "name": "Apple"
      },
      {
        "type": "Tree",
        "name": "Chestnut"
      },
      {
        "type": "Tree",
        "name": "Black Cherry"
      }
    ]

    const defaultForadexConfig = {
      "defaultResourceType": "Mushroom",
    }

    const copyToClipboard = (textToCopy) => {
      const textArea = document.createElement('textarea');
      textArea.value = textToCopy;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
    }

    const createOption = (value) => {
          let opt = document.createElement("option")
          opt.value = value
          opt.innerHTML = value
          return opt
    }

    const findFind = (body) => {
        let foradex = getForadex()
        for(const find of foradex.find) {
            console.log("FIND: " + find)
            console.log("BODY: " + body)
            if (find.date === body.date && find.name === body.name && find.type === body.type && find.locationName === body.locationName && find.locationLong === body.locationLong && find.locationLat === body.locationLat) {
                return find
            }
        }
        return null
    }

    const deleteFind = (deleteFind) => {
        let foradex = getForadex()
        foradex.find.map((find, i) => {
        // I wish javascript had a built in ability to compare objects here
        //  this implementation is also a little silly but will due for now.
        //  I think we might run out of localStorage place before this 
        //  starts to become noticably ineffecient.
        console.log("attempting to delete")
        if (find.date === deleteFind.date && find.name === deleteFind.name && find.type === deleteFind.type && find.locationName === deleteFind.locationName && find.locationLong === deleteFind.locationLong && find.locationLat === deleteFind.locationLat) {
          foradex.find.splice(i, 1)
          setForadex(foradex)
        }
      })
    }


    const setFindInfo = (find) => {
        setSelectedFind(find)
        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${find.locationLat},${find.locationLong}`
        const findBlob = btoa(JSON.stringify(find))
        const shareUrl = `https://andrewcopeland.github.io/foradex?share=${findBlob}`
        const findInfoMapping = {
            "find-info-date": { innerHtml: `<p><b>Date:</b> ${find.date}</p>`},
            "find-info-location": { innerHtml: `<p><b>Location:</b> ${find.locationName}</p>`},
            "find-info-name": { innerHtml: `<p><b>Name:</b> ${find.name}</p>`},
            "find-info-type": { innerHtml: `<p><b>Type:</b> ${find.type}</p>`},
            "find-info-lat": { innerHtml: `<p><b>Latitude:</b> ${find.locationLat}</p>`},
            "find-info-long": { innerHtml: `<p><b>Longitude:</b> ${find.locationLong}</p>`},
        }

        for (const [elementId, config] of Object.entries(findInfoMapping)) {
            let e = document.getElementById(elementId)
            e.innerHTML = config.innerHtml
            if ("listener" in config) {
                config.listener(e)
            }
        }

        findInfoOn()
    }

    const refreshForadexTable = () => {
      console.log("Refreshing foradex table")
      const actualForadex = getForadex()

      const createForadexCell = (value) => {
          let cell = document.createElement("th")
          cell.innerText = value
          return cell
      }

      const createActionCell = (find) => {
        let cell = document.createElement("th")
        let share = document.createElement("a")
        share.innerText = "Info"
        share.href = "#0"
        share.addEventListener("click", () => {
            setFindInfo(find)
        })
        cell.appendChild(share)
        return cell
      }

      const createForadexRow = (find) => {
        let row = document.createElement("tr")
        row.appendChild(createForadexCell(find.date))
        row.appendChild(createForadexCell(find.locationName))
        row.appendChild(createForadexCell(find.name))
        // row.appendChild(createForadexCell(find.type))
        // row.appendChild(createForadexCell(find.locationLat))
        // row.appendChild(createForadexCell(find.locationLong))
        row.appendChild(createActionCell(find))
        return row
      }

      let tableForadex = document.getElementById("foradex-table-body")
      tableForadex.innerHTML = ""
      actualForadex.find.reverse().map((find, i ) => {
        tableForadex.appendChild(createForadexRow(find))
      })
    }

    const mergeSharedFind = () => {
      const urlParams = new URL(window.location.href)
      const shareParam = urlParams.searchParams.get("share")
      if (shareParam !== null) {
        const find = JSON.parse(atob(shareParam))
        console.log("a share param was provided")
        appendResource("find", find)
      } else {
        console.log("a share param was not provided")
      }
    }

    const findInfoOn = () => {
        let findInfo = document.getElementById("find-info")
        findInfo.style = ""
    }

    const findInfoOff = () => {
        let findInfo = document.getElementById("find-info")
        findInfo.style = "display: none;"
    }

    const setSelectedFind = (find) => {
        localStorage.setItem("selectedFind", JSON.stringify(find))
    }

    const getSelectedFind = () => {
        return JSON.parse(localStorage.getItem("selectedFind"))
    }

    const initForadex = () => {
        const foradex = localStorage.getItem("foradex")
        if (foradex === null) {
          setForadex({
            "resource": defaultResources,
            "find": [],
            "resourceType": defaultResourceTypes,
            "config": defaultForadexConfig
          })        
        }

        const actualForadex = getForadex()

        // populate the selects for resource and find type
        let selectResourceType = document.getElementById("resource-type")
        let selectFindType = document.getElementById("find-type")
        actualForadex.resourceType.map((resourceType, i) => {
          selectResourceType.appendChild(createOption(resourceType))
          selectFindType.appendChild(createOption(resourceType))
        })

        // refresh table
        refreshForadexTable()

        // refresh name select
        refreshFindNameSelect()
        

        // populate the find date
        let dateFindDate = document.getElementById("find-date")
        const currentDate = getCurrentDate()
        console.log("current date: " + currentDate)
        dateFindDate.value = currentDate

        // at this point on initializing the foradex
        //  check if the `share` query parameter exists so we can
        //  merge this shared find
        mergeSharedFind()
    }

    const getCurrentDate = () => {
      const currentDate = new Date();
      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const day = String(currentDate.getDate()).padStart(2, '0');
      const formattedDate = `${year}-${month}-${day}`;
      return formattedDate;
    }
    
    const getForadex = () => {
        return JSON.parse(localStorage.getItem("foradex"))
    }

    const setForadex = (foradex) => {
        localStorage.setItem("foradex", JSON.stringify(foradex))
        refreshFindNameSelect()
        refreshForadexTable()
    }

    const appendResource = (type, body) => {
        if (type === "find") {
            const find = findFind(body)
            console.log("Found this find: " + find)
            if (find !== null) {
                alert("Failed to add find - Already exists")
                throw new Error("Failed to add find - Already exists")
            }
        }
        let foradex = getForadex()
        // here we should validate that the resource/find being appeneded does not already exists

        const currentItems = foradex[type]
        for(const item of currentItems) {
            let duplicateItem = true
            for (const [field, value] of Object.entries(item)) {
                // iterate over all the fields and if any of the currentValues are not 
                if (body[field] !== value) {
                    duplicateItem = false
                }
            }
        }
        foradex[type].push(body)
        setForadex(foradex)
    }

    const saveFormData = () => {
      const name = document.getElementById("find-name").value;
      const type = document.getElementById("find-type").value;
      const date= document.getElementById("find-date").value;
      const locationName = document.getElementById("find-locationName").value;
      const locationLong = document.getElementById("find-locationLong").value;
      const locationLat = document.getElementById("find-locationLat").value;

      const formData = {
        name: name,
        type: type,
        date: date,
        locationName: locationName,
        locationLong: locationLong,
        locationLat: locationLat
      };

      appendResource("find", formData)

      alert("Find saved!");
    }

    const saveResourceForm = () => {
      const type = document.getElementById("resource-type").value
      const name = document.getElementById("resource-name").value

      const data = {
        type: type,
        name: name
      }
      appendResource("resource", data) 

      alert("Resource saved!");
    }

    const getCurrentLocation = () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            // Do something with the latitude and longitude values
            console.log(position.coords)
            console.log("Latitude: " + latitude);
            console.log("Longitude: " + longitude);

            // set the elements
            let locationLongElement = document.getElementById("find-locationLong") 
            let locationLatElement = document.getElementById("find-locationLat")
            locationLongElement.value = longitude
            locationLatElement.value = latitude
          },
          function(error) {
            console.error("Error getting location:", error);
          }
        );
      } else {
        console.error("Geolocation is not supported by this browser.");
      }
    }

    const initWebsite = () => {
        initForadex()
        getCurrentLocation()
    }

    const refreshFindNameSelect = () => {
      console.log("refreshing find-name select")
      let findTypeSelect = document.getElementById("find-type")
      const resourceType = findTypeSelect.value

      let findNameSelect = document.getElementById("find-name")
      findNameSelect.innerHTML = ""
      
      const foradex = getForadex()
      foradex.resource.map((resource, i) => {
        if (resource.type === resourceType) {
          findNameSelect.appendChild(createOption(resource.name))
        }
      })
    }

    const downloadFile = (content, fileName, contentType) => {
      const a = document.createElement('a');
      const blob = new Blob([content], { type: contentType });
      a.href = window.URL.createObjectURL(blob);
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(a.href);
    }

    function restoreForadexFromFile() {
      const fileInput = document.getElementById('restore-foradex-input');
      fileInput.click();
      fileInput.addEventListener('change', function() {
        const selectedFile = fileInput.files[0];
        if (selectedFile) {
          const reader = new FileReader();
          reader.onload = function(event) {
            const fileContent = event.target.result;
            console.log('File content as string:', fileContent);
            setForadex(JSON.parse(fileContent))
            location.reload()
          };
          reader.readAsText(selectedFile);
        }
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
        // listener config gets the element by the id provided as the key and sets 
        //  an event listener
        const listenerConfig = {
            "find-type": {
                type: "change",
                listener: (e) => {
                    refreshFindNameSelect()
                }
            },
            "reset-foradex": {
                type: "click",
                listener: (e) => {
                    if (confirm("Are you sure you want to delete your entire Foradex?")) {
                        localStorage.clear()
                        location.reload()
                    }
                }
            },
            "backup-foradex": {
                type: "click",
                listener: (e) => {
                    downloadFile(JSON.stringify(getForadex()), `foradex-${getCurrentDate()}.json`, "application/json")
                }
            },
            "restore-foradex": {
                type: "click",
                listener: (e) => {
                    if (confirm("Are you sure you want to restore Foradex (this will override your current foradex)?")) {
                        restoreForadexFromFile()
                    }
                }
            },
            "find-info-hide": {
                type: "click",
                listener: (e) => {
                    findInfoOff()
                }
            },
            "find-info-map": {
                type: "click",
                listener: (e) => {
                    const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${find.locationLat},${find.locationLong}`
                    window.location.href = googleMapsUrl
                }
            },
            "find-info-share": {
                type: "click",
                listener: (e) => {
                    const find = getSelectedFind()
                    const findBlob = btoa(JSON.stringify(find))
                    const shareUrl = `https://andrewcopeland.github.io/foradex?share=${findBlob}`
                    copyToClipboard(shareUrl)
                    alert("Copied foradex share link to clipboard.")
                }
            },
            "find-info-delete": {
                type: "click",
                listener: (e) => {
                    const find = getSelectedFind()
                    if(confirm("Are you sure you want to Delete this find?")) {
                        deleteFind(find)
                        findInfoOff()
                    }
                }
            }
        }

        for (const [elementId, config] of Object.entries(listenerConfig)) {
            let element = document.getElementById(elementId)
            element.addEventListener(config.type, config.listener)
        }
    })

    window.onload = initWebsite
  </script>
</head>
<body>
  <h1>Foradex</h1>
  <h4>a tool that logs a forager's findings and location</h4>
  <hr/>
  <h2>New Resource</h2>
  <form>
    <div style="display: flex;column-gap: 10px;">
      <div>
        <label for="type">Type:</label>
        <select id="resource-type" name="type" required>
        </select>
      </div>
      <div>
        <label for="name">Name:</label>
        <input type="text" id="resource-name" name="name" required>
      </div>
    </div>
    <button type="button" onclick="saveResourceForm()">Submit</button>
  </form>
  <hr/>
  <h2>New Find</h2>
  <form>
    <div style="display: flex;column-gap: 10px;">
      <div>
        <label for="type">Type:</label>
        <select id="find-type" name="type" required>
        </select>
      </div>
      <div>
        <label for="name">Name:</label>
        <select id="find-name" name="name" style="max-width: 220px;"required>
          <option value="" selected disabled>Select an option</option>
        </select>
      </div>
    </div>
    
    <label for="locationName">Location Name:</label>
    <input type="text" id="find-locationName" name="locationName" required>
    
    <div style="display: flex;column-gap: 10px;">
        <div>
            <label for="locationLat">Latitude:</label>
            <input type="text" id="find-locationLat" name="locationLat" style="width: 100px;" required>
        </div>
        <div>
            <label for="locationLong">Longitude:</label>
            <input type="text" id="find-locationLong" name="locationLong" style="width: 100px;" required>
        </div>
    </div>

    <label for="date">Date:</label>
    <input type="date" id="find-date" name="date" required>

    <button type="button" onclick="saveFormData()">Submit</button>
  </form>
  <hr/>
  <div id="find-info" style="display: none;">
    <h2>Find Info <a id="find-info-hide" href="#0">(hide)</a></h2>
    <p id="find-info-date"></p>
    <p id="find-info-location"></p>
    <p id="find-info-name"></p>
    <p id="find-info-type"></p>
    <p id="find-info-lat"></p>
    <p id="find-info-long"></p>
    <button id="find-info-map">
        Google Maps
    </a>
    <button id="find-info-share">
        Share this Find
    </button>
    <button id="find-info-delete" style="color: red;">
        Delete
    </button>
    <hr/>
  </div>
  <h2>My Finds</h2>
  <table id="foradex-table" class="foradex-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Location</th>
        <th>Name</th>
        <!-- <th>Type</th> -->
        <!-- <th>Latitude</th>
        <th>Longitude</th> -->
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="foradex-table-body">
    </tbody>
  </table>
  <hr/>
  <h2>Motivation</h2>
  <p>I was frustrated with the bloated foraging apps that currently exist and wanted a simple light weight tool to log my foraging finds.</p>
  <p>Own <b>all your data</b></p>
  <p>No <b>login required</b></p>
  <p>No <b>internet required</b></p>
  <p>No <b>cloud storage</b></p>
  <p>Hopefully we can share our foradexes some day 😜</p>
  <hr/>
  <div style="display:flex;column-gap:10px;">
      <a href="https://github.com/AndrewCopeland/foradex">Github</a>
      <a id="backup-foradex" href="#">Backup Foradex</a>
      <a id="restore-foradex" href="#">Restore Foradex</a>
      <a id="reset-foradex" style="color:red;" href="#">Reset Foradex</a>
  </div>
  <input type="file" id="restore-foradex-input" style="display:none;">
</body>
</html>
